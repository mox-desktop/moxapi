<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <title>htmx App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-zinc-950 text-zinc-200 font-sans w-full min-h-screen p-0 m-0">
  <div class="header-bar py-2 pb-1">
    <div class="header-content w-4/5 min-w-[300px] max-w-4/5 mx-auto flex items-center gap-2 justify-between px-0">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="lucide lucide-server h-6 w-6" aria-hidden="true">
          <rect width="20" height="8" x="2" y="2" rx="2" ry="2"></rect>
          <rect width="20" height="8" x="2" y="14" rx="2" ry="2"></rect>
          <line x1="6" x2="6.01" y1="6" y2="6"></line>
          <line x1="6" x2="6.01" y1="18" y2="18"></line>
        </svg>
        <h1 class="text-xl font-semibold">Desktop Host Manager</h1>
      </div>
      <button
        class="flex items-center gap-2 rounded-md text-sm font-medium transition bg-transparent border border-zinc-900 shadow h-9 px-4 cursor-pointer text-zinc-200 hover:bg-zinc-900 hover:text-white"
        id="add-host-btn" hx-get="/add-host-form" hx-target="#add-host-modal-content" hx-trigger="click"
        hx-swap="innerHTML">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="lucide lucide-plus">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Host
      </button>
    </div>
  </div>
  <hr class="border-none border-t-[1.5px] border-zinc-800 m-0 w-full sm:w-[80%] mx-0 sm:mx-auto" />
  <div class="section-bar flex justify-between max-w-none mx-0 mt-6 items-center pl-2 pr-2 sm:min-w-[300px] sm:max-w-4/5 sm:mx-auto sm:pl-[10%] sm:pr-[10%]">
    <div>
      <div class="section-title text-lg font-semibold mb-0.5">Host Management</div>
      <div class="section-desc text-base text-zinc-400 font-normal">Manage your desktop hosts and their configurations
      </div>
    </div>
  </div>
  <div id="host-tabs"
    class="host-tabs flex flex-wrap gap-3 my-8 mx-0 max-w-none justify-start pl-2 pr-2 sm:min-w-[300px] sm:max-w-4/5 sm:mx-auto sm:pl-[10%] sm:pr-[10%]"></div>
  <div id="host-panel"></div>
  <div id="dashboard"></div>
  <div class="modal-overlay fixed inset-0 bg-black/70 hidden items-center justify-center z-[1000]" id="add-host-modal">
    <div class="modal bg-zinc-900 text-zinc-200 rounded-lg p-8 pt-8 pb-6 min-w-[280px] max-w-[90vw] shadow-2xl relative" id="add-host-modal-content">
      <!-- Modal content will be injected here by htmx -->
    </div>
  </div>
  <script>
    document.body.addEventListener('htmx:afterSwap', function (evt) {
      console.log('htmx:afterSwap fired', evt.detail);
      if (evt.detail.target.id === 'add-host-modal-content') {
        document.getElementById('add-host-modal').classList.add('active');
      }
    });
    document.body.addEventListener('click', function (evt) {
      if (evt.target.matches('.modal-cancel')) {
        document.getElementById('add-host-modal').classList.remove('active');
        document.getElementById('add-host-modal-content').innerHTML = '';
      }
    });
    document.body.addEventListener('htmx:afterRequest', function (evt) {
      if (evt.detail.target.id === 'add-host-modal-content' && evt.detail.xhr.status === 200 && evt.detail.requestConfig.verb === 'post') {
        document.getElementById('add-host-modal').classList.remove('active');
        document.getElementById('add-host-modal-content').innerHTML = '';
      }
    });
    fetch('/hosts')
      .then(r => r.json())
      .then(hosts => {
        const tabs = document.getElementById('host-tabs');
        tabs.innerHTML = '';
        let selected = null;
        let idx = 0;
        for (const [hostname, host] of Object.entries(hosts)) {
          const status = idx === 0 ? 'online' : idx === 1 ? 'idle' : 'offline';
          const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
          const btn = document.createElement('button');
          btn.className = 'host-tab flex items-center gap-4 rounded-xl border border-zinc-800 bg-zinc-900 text-zinc-400 shadow px-6 py-3 min-w-[220px] relative transition-colors font-medium hover:bg-zinc-800 hover:text-white hover:border-white';
          btn.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="monitor-icon w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="8" x="2" y="2" rx="2" ry="2"></rect><rect width="20" height="8" x="2" y="14" rx="2" ry="2"></rect><line x1="6" x2="6.01" y1="6" y2="6"></line><line x1="6" x2="6.01" y1="18" y2="18"></line></svg>
              <span class="status-dot w-2.5 h-2.5 rounded-full ml-1 mr-2 inline-block ${status === 'online' ? 'bg-green-500' : status === 'idle' ? 'bg-yellow-400' : 'bg-red-500'}"></span>
            </div>
            <div class="host-info flex flex-col items-start flex-1">
              <span class="host-name font-semibold text-base mb-0.5">${hostname}</span>
              <span class="host-ip text-sm text-zinc-400">${host.ip}</span>
            </div>
            <span class="status-badge inline-flex items-center text-xs font-semibold rounded-full px-3 py-1 ml-2 capitalize transition-colors ${status === 'online' ? 'bg-green-500 text-white' : status === 'idle' ? 'bg-yellow-400 text-zinc-900' : 'bg-red-500 text-white'}">${statusLabel}</span>
          `;
          btn.setAttribute('hx-get', `/host-panel/${encodeURIComponent(hostname)}`);
          btn.setAttribute('hx-target', '#host-panel');
          btn.setAttribute('hx-swap', 'innerHTML');
          btn.addEventListener('click', function () {
            if (selected) selected.classList.remove('selected', 'bg-zinc-800', 'text-white', 'border-white');
            btn.classList.add('selected', 'bg-zinc-800', 'text-white', 'border-white');
            selected = btn;
            htmx.ajax('GET', `/dashboard/${encodeURIComponent(hostname)}`, '#dashboard');
          });
          if (idx === 0) {
            btn.classList.add('selected', 'bg-zinc-800', 'text-white', 'border-white');
            selected = btn;
            setTimeout(() => {
              btn.click();
              htmx.ajax('GET', `/dashboard/${encodeURIComponent(hostname)}`, '#dashboard');
            }, 0);
          }
          tabs.appendChild(btn);
          idx++;
        }
      });
  </script>
</body>

</html>