name: Deploy images
on:
  push:
    branches:
      - main
  release:
    types: [published]
permissions:
  packages: write
jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v23
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Setup Cachix
        uses: cachix/cachix-action@v12
        with:
          name: nix-community
          skipPush: true
      
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push server image
        run: |
          echo "Building Docker image with Nix..."
          nix build .#dashboard
          
          echo "Loading image into Docker..."
          docker load < result
          
          BUILT_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep server | head -1)
          echo "Built server image: $BUILT_IMAGE"
          
          # Extract metadata
          BRANCH=${GITHUB_REF#refs/heads/}
          COMMIT_SHA=${GITHUB_SHA::7}
          IS_DEFAULT_BRANCH=${{ github.ref == 'refs/heads/main' }}
          IS_RELEASE=${{ github.event_name == 'release' }}
          
          # Server tags
          SERVER_TAGS=()
          SERVER_TAGS+=("ghcr.io/unixpariah/moxapi:${BRANCH}")
          SERVER_TAGS+=("ghcr.io/unixpariah/moxapi:${COMMIT_SHA}")
          SERVER_TAGS+=("ghcr.io/unixpariah/moxapi:${BRANCH}-${COMMIT_SHA}")
          
          if [ "$IS_DEFAULT_BRANCH" = "true" ]; then
            SERVER_TAGS+=("ghcr.io/unixpariah/moxapi:latest")
          fi
          
          if [ "$IS_RELEASE" = "true" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            SERVER_TAGS+=("ghcr.io/unixpariah/moxapi:${TAG_NAME}")
            if [[ $TAG_NAME =~ ^v?([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              SERVER_TAGS+=("ghcr.io/unixpariah/moxapi:${BASH_REMATCH[1]}")
            fi
          fi
          
          # Tag and push server images
          for tag in "${SERVER_TAGS[@]}"; do
            echo "Tagging and pushing server: $tag"
            docker tag "$BUILT_IMAGE" "$tag"
            docker push "$tag"
          done
          
          # Clean up server image
          docker rmi "$BUILT_IMAGE" || true
          rm -f result
          
          echo "Successfully pushed all images"
